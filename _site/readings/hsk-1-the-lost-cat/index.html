<!doctype html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>The Lost Cat (迷路的小猫) [HSK1]</title>
        
        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        
        <!-- Pinyin Pro -->
        <script src="https://cdn.jsdelivr.net/npm/pinyin-pro"></script>
    
        <!-- Include Marked.js (Markdown parser) -->
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        
        <style>
            h1 {
                font-size: 48px;
                font-weight:bolder;
            }
            h2 {
                font-size: 36px;
                font-weight:bolder;
            }
            body {
                font-family: Arial, sans-serif;
                padding: 20px;
            }
            .dialog-container {
                margin-top: 20px;
            }
            .dialog {
                margin-bottom: 10px; /* Reduced spacing */
                line-height: 1.5; /* Reduced line height */
                display: flex;
                flex-wrap: wrap;
                align-items: flex-start; /* Left align text */
                flex-direction: column;
            }
            .dialog-new-words {
                margin-bottom: 10px; /* Reduced spacing */
                line-height: 1; /* Reduced line height */
                display: flex;
                flex-wrap: wrap;
                align-items: flex-start; /* Left align text */
                flex-direction: column;
            }
            .hanzi-line {
                display: flex;
                flex-wrap: wrap;
                align-items: flex-end;
            }
            .hanzi-group {
                position: relative;
                display: inline-flex;
                flex-direction: column;
                align-items: center;
                font-size: 24px;
                margin: 3px;
                cursor: pointer;
                min-width: 1em;
            }
            .pinyin {
                display: none;
                font-size: 16px;
                color: gray;
                line-height: 1;
            }
            .show-pinyin .pinyin {
                display: block;
            }
            .pinyin-dictionary {
                font-size: 20px;
                margin: 3px;
                display: inline;
                vertical-align: baseline;
                color: gray;
            }
            .plain-text {
                font-size: 24px;
                margin: 3px;
                display: inline;
                vertical-align: baseline;
            }
            .plain-text-body {
                font-size: 24px;
                margin: 3px;
                display: inline;
                color: #444444;
                vertical-align: baseline;
            }
            .plain-text-title {
                font-size: 24px;
                font-weight:bold;
                margin: 3px;
                display: inline;
                vertical-align: baseline;
            }
            .translation {
                line-height: 1;
                display: none;
                font-size: 18px;
                color: gray;
                margin-top: 3px; /* Reduced spacing */
            }
            .show-translation .translation {
                display: block;
            }
            .section-markdown-container {
                background-color: #f1f1f1;
                padding: 1.2em;
            }
        </style>
    </head>
  <body>
    <H3><a href="/">Home</a>&nbsp;&nbsp;<a href="/lessons">Lessons</a>&nbsp;&nbsp;<a href="/readings">Readings</a></H3>
    <div class="container">
    <br />
    <br />
    <div class="d-flex justify-content-between align-items-center">
        <h1>The Lost Cat (迷路的小猫) [HSK1]</h1>
    </div>
    <p class="plain-text-body">
</p>
    <br />
    <br />
    <br />
    <br />
    <div class="d-flex justify-content-between align-items-center">
        <h2>Dialogs</h2>
        <div>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="togglePinyin">
                <label class="form-check-label" for="togglePinyin">Show Pinyin</label>
            </div>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="toggleTranslation">
                <label class="form-check-label" for="toggleTranslation">Show Translation</label>
            </div>
        </div>
    </div>


    <div class="hanzi-section" 
        data-title="The Lost Cat (迷路的小猫) [HSK1]"
        data-hanzi="小猫在椅子下。你们看见它吗？
王方的家有一只小猫，名字叫大卫。今年它三岁了，很可爱。
今天上午，王方去学校，爸爸去医院工作，妈妈去商店买东西。大卫在家，可是它想去外面玩。
它跳上桌子，看见窗前的天气很好，不下雨，也不太热。于是，它跳下桌子，走出家门。
下午，王方回家，看见椅子下没有小猫。他问妈妈：“你看见大卫了吗？” 妈妈说：“没看见。”
王方很着急，去学校、商店、医院找。他问：“请问，你看见我的小猫了吗？” 朋友们都说：“没看见。”
天快黑了，王方走到饭店前面，看见一只小猫在那里。他大声叫：“大卫！” 小猫也看见王方，马上跑过去。
王方抱着小猫，高兴地说：“我们回家吧！”
（完）" 
        data-translation="The kitten is under the chair. Do you see it?
Wang Fang's family has a kitten named David. This year, it is three years old and very cute.
This morning, Wang Fang went to school, his father went to work at the hospital, and his mother went to the store to buy things. David was at home, but he wanted to go outside to play.
He jumped onto the table and saw that the weather outside the window was nice—not raining and not too hot. So, he jumped off the table and walked out the door.
In the afternoon, Wang Fang came home and saw that there was no kitten under the chair. He asked his mother, 'Have you seen David?' Mom said, 'No, I haven't.'
Wang Fang was very worried and went to the school, store, and hospital to look for him. He asked, 'Excuse me, have you seen my kitten?' His friends all said, 'No, we haven't.'
As it was getting dark, Wang Fang walked in front of a restaurant and saw a kitten there. He shouted loudly, 'David!' The kitten also saw Wang Fang and immediately ran over.
Wang Fang held the kitten and happily said, 'Let's go home!'
(The end)"
        data-dictionary="%7B%22%E5%B0%8F%E7%8C%AB%22%3A%20%22n.%20kitten%22%2C%20%22%E6%A4%85%E5%AD%90%22%3A%20%22n.%20chair%22%2C%20%22%E7%9C%8B%E8%A7%81%22%3A%20%22v.%20to%20see%22%2C%20%22%E5%AE%83%22%3A%20%22pron.%20it%22%2C%20%22%E5%AE%B6%22%3A%20%22n.%20home%2C%20family%22%2C%20%22%E5%90%8D%E5%AD%97%22%3A%20%22n.%20name%22%2C%20%22%E4%BB%8A%E5%B9%B4%22%3A%20%22n.%20this%20year%22%2C%20%22%E5%8F%AF%E7%88%B1%22%3A%20%22adj.%20cute%22%2C%20%22%E4%B8%8A%E5%8D%88%22%3A%20%22n.%20morning%22%2C%20%22%E5%AD%A6%E6%A0%A1%22%3A%20%22n.%20school%22%2C%20%22%E5%8C%BB%E9%99%A2%22%3A%20%22n.%20hospital%22%2C%20%22%E5%B7%A5%E4%BD%9C%22%3A%20%22v.%20to%20work%22%2C%20%22%E5%95%86%E5%BA%97%22%3A%20%22n.%20store%2C%20shop%22%2C%20%22%E4%B9%B0%E4%B8%9C%E8%A5%BF%22%3A%20%22v.%20to%20buy%20things%22%2C%20%22%E5%A4%96%E9%9D%A2%22%3A%20%22n.%20outside%22%2C%20%22%E7%8E%A9%22%3A%20%22v.%20to%20play%22%2C%20%22%E6%A1%8C%E5%AD%90%22%3A%20%22n.%20table%22%2C%20%22%E7%AA%97%E5%89%8D%22%3A%20%22n.%20in%20front%20of%20the%20window%22%2C%20%22%E5%A4%A9%E6%B0%94%22%3A%20%22n.%20weather%22%2C%20%22%E4%B8%8B%E9%9B%A8%22%3A%20%22v.%20to%20rain%22%2C%20%22%E5%A4%AA%E7%83%AD%22%3A%20%22adj.%20too%20hot%22%2C%20%22%E5%AE%B6%E9%97%A8%22%3A%20%22n.%20house%20door%22%2C%20%22%E5%9B%9E%E5%AE%B6%22%3A%20%22v.%20to%20return%20home%22%2C%20%22%E7%9D%80%E6%80%A5%22%3A%20%22adj.%20anxious%2C%20worried%22%2C%20%22%E8%AF%B7%E9%97%AE%22%3A%20%22phr.%20Excuse%20me%2C%20may%20I%20ask%22%2C%20%22%E6%9C%8B%E5%8F%8B%E4%BB%AC%22%3A%20%22n.%20friends%22%2C%20%22%E5%BF%AB%E9%BB%91%E4%BA%86%22%3A%20%22phr.%20getting%20dark%22%2C%20%22%E9%A5%AD%E5%BA%97%22%3A%20%22n.%20restaurant%22%2C%20%22%E5%89%8D%E9%9D%A2%22%3A%20%22n.%20front%22%2C%20%22%E9%AB%98%E5%85%B4%22%3A%20%22adj.%20happy%22%2C%20%22%E6%8A%B1%E7%9D%80%22%3A%20%22v.%20to%20hold%2C%20to%20hug%22%7D">
    </div>

    <br />
    <br />
    <br />
    <br />
    <div class="new-words-section"
        data-dictionary="%7B%22%E5%B0%8F%E7%8C%AB%22%3A%20%22n.%20kitten%22%2C%20%22%E6%A4%85%E5%AD%90%22%3A%20%22n.%20chair%22%2C%20%22%E7%9C%8B%E8%A7%81%22%3A%20%22v.%20to%20see%22%2C%20%22%E5%AE%83%22%3A%20%22pron.%20it%22%2C%20%22%E5%AE%B6%22%3A%20%22n.%20home%2C%20family%22%2C%20%22%E5%90%8D%E5%AD%97%22%3A%20%22n.%20name%22%2C%20%22%E4%BB%8A%E5%B9%B4%22%3A%20%22n.%20this%20year%22%2C%20%22%E5%8F%AF%E7%88%B1%22%3A%20%22adj.%20cute%22%2C%20%22%E4%B8%8A%E5%8D%88%22%3A%20%22n.%20morning%22%2C%20%22%E5%AD%A6%E6%A0%A1%22%3A%20%22n.%20school%22%2C%20%22%E5%8C%BB%E9%99%A2%22%3A%20%22n.%20hospital%22%2C%20%22%E5%B7%A5%E4%BD%9C%22%3A%20%22v.%20to%20work%22%2C%20%22%E5%95%86%E5%BA%97%22%3A%20%22n.%20store%2C%20shop%22%2C%20%22%E4%B9%B0%E4%B8%9C%E8%A5%BF%22%3A%20%22v.%20to%20buy%20things%22%2C%20%22%E5%A4%96%E9%9D%A2%22%3A%20%22n.%20outside%22%2C%20%22%E7%8E%A9%22%3A%20%22v.%20to%20play%22%2C%20%22%E6%A1%8C%E5%AD%90%22%3A%20%22n.%20table%22%2C%20%22%E7%AA%97%E5%89%8D%22%3A%20%22n.%20in%20front%20of%20the%20window%22%2C%20%22%E5%A4%A9%E6%B0%94%22%3A%20%22n.%20weather%22%2C%20%22%E4%B8%8B%E9%9B%A8%22%3A%20%22v.%20to%20rain%22%2C%20%22%E5%A4%AA%E7%83%AD%22%3A%20%22adj.%20too%20hot%22%2C%20%22%E5%AE%B6%E9%97%A8%22%3A%20%22n.%20house%20door%22%2C%20%22%E5%9B%9E%E5%AE%B6%22%3A%20%22v.%20to%20return%20home%22%2C%20%22%E7%9D%80%E6%80%A5%22%3A%20%22adj.%20anxious%2C%20worried%22%2C%20%22%E8%AF%B7%E9%97%AE%22%3A%20%22phr.%20Excuse%20me%2C%20may%20I%20ask%22%2C%20%22%E6%9C%8B%E5%8F%8B%E4%BB%AC%22%3A%20%22n.%20friends%22%2C%20%22%E5%BF%AB%E9%BB%91%E4%BA%86%22%3A%20%22phr.%20getting%20dark%22%2C%20%22%E9%A5%AD%E5%BA%97%22%3A%20%22n.%20restaurant%22%2C%20%22%E5%89%8D%E9%9D%A2%22%3A%20%22n.%20front%22%2C%20%22%E9%AB%98%E5%85%B4%22%3A%20%22adj.%20happy%22%2C%20%22%E6%8A%B1%E7%9D%80%22%3A%20%22v.%20to%20hold%2C%20to%20hug%22%7D"
    ></div>
</div>
  </body>
  <!-- Bootstrap JS (for Popovers) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
      function isHanzi(char) {
          return /[\u4e00-\u9fff]/.test(char);
      }

      function decodeDictionary(encodedString) {
          return JSON.parse(decodeURIComponent(encodedString));
      }

      let activePopover = null; // Track the currently open popover

      function generateMarkdowns() {
          document.querySelectorAll(".markdown-container").forEach(markdownSection => {
              dataMarkdown = decodeURIComponent(markdownSection.getAttribute("data-markdown"));
              markdownSection.innerHTML = marked.parse(dataMarkdown);
          })
      }


      function generateSections() {
          document.querySelectorAll(".new-words-section").forEach(newWordsSection => {
              const dataDictionary = decodeDictionary(newWordsSection.getAttribute("data-dictionary"))
              newWordsSection.innerHTML = "";
              const newWordsDialog = document.createElement("div");
              newWordsDialog.classList.add("dialog-new-words");

              const title = document.createElement("p");
              title.classList.add("hanzi-line")

              const titleSpan = document.createElement("span");
              titleSpan.classList.add("plain-text-title");
              titleSpan.textContent = "New Words";
              title.appendChild(titleSpan);
              newWordsDialog.appendChild(title);

              for(let word in dataDictionary) {
                  const entry = document.createElement("p");
                  entry.classList.add("hanzi-line");
                  createHanziSpan(entry, word, dataDictionary);

                  const pinyinSpan = document.createElement("span");
                  pinyinSpan.classList.add("pinyin-dictionary");
                  pinyinSpan.textContent = "   " + (pinyinPro.pinyin(word, { toneType: "mark" }) || "")
                  entry.appendChild(pinyinSpan);


                  const entrySpan = document.createElement("span");
                  entrySpan.classList.add("plain-text");
                  entrySpan.textContent = "  :  " + dataDictionary[word];
                  entry.appendChild(entrySpan)
                  newWordsDialog.appendChild(entry)
              }
              newWordsSection.replaceWith(newWordsDialog);
          })

          document.querySelectorAll(".hanzi-section").forEach(section => {
              const hanziText = section.getAttribute("data-hanzi");
              const translationText = section.getAttribute("data-translation");
              const dataDictionary = decodeDictionary(section.getAttribute("data-dictionary"))
              const dataTitle = section.getAttribute("data-title");
              const dataMarkdown = section.getAttribute("data-markdown");

              const sectionDiv = document.createElement("div");
              sectionDiv.classList.add("dialog-container");

              generateDialogFromText(sectionDiv, dataTitle, hanziText, translationText, dataDictionary, dataMarkdown);

              section.replaceWith(sectionDiv);
          });

          updatePinyinDisplay();
          updateTranslationDisplay();
          initializePopovers();
      }

function generateDialogFromText(contentDiv, dataTitle, text, translationText, dataDictionary, dataMarkdown) {
  contentDiv.innerHTML = ""; // Clear previous content

  
  const titleDialog = document.createElement("div");
  titleDialog.classList.add("dialog")

  const title = document.createElement("p");
  title.classList.add("hanzi-line")

  const titleSpan = document.createElement("span");
  titleSpan.classList.add("plain-text-title");
  titleSpan.textContent = dataTitle;

  title.appendChild(titleSpan);
  titleDialog.appendChild(title);
  contentDiv.appendChild(titleDialog);  
  
  const hanziLines = text.trim().split("\n");
  const translationLines = translationText.trim().split("\n");

  hanziLines.forEach((line, index) => {
      const container = document.createElement("div");
      container.classList.add("dialog");

      const paragraph = document.createElement("p");
      paragraph.classList.add("hanzi-line");

      let indexChar = 0;
      while (indexChar < line.length) {
          let foundWord = false;

          for (let word in dataDictionary) {
              if (line.startsWith(word, indexChar)) {
                  createHanziSpan(paragraph, word, dataDictionary);
                  indexChar += word.length;
                  foundWord = true;
                  break;
              }
          }

          if (!foundWord) {
              let char = line[indexChar];

              if (isHanzi(char)) {
                  createHanziSpan(paragraph, char, dataDictionary);
              } else {
                  createPlainTextSpan(paragraph, char);
              }
              indexChar++;
          }
      }

      container.appendChild(paragraph);

      // Create translation line
      if (index < translationLines.length) {
          const translationPara = document.createElement("p");
          translationPara.classList.add("translation");
          translationPara.textContent = translationLines[index].trim();
          container.appendChild(translationPara);
      }

      contentDiv.appendChild(container);

  });

  if(dataMarkdown !== null) {
      markdownContainer = document.createElement("div");
      markdownContainer.classList.add("section-markdown-container");
      markdownContent = document.createElement("div");
      markdownContent.innerHTML = marked.parse(decodeURIComponent(dataMarkdown));
      markdownContainer.appendChild(markdownContent);
      contentDiv.appendChild(markdownContainer);
      
  }

  // updatePinyinDisplay();
  // updateTranslationDisplay();
  // initializePopovers(); // **Fix: Ensure popovers are initialized**
}

function createHanziSpan(parent, hanziWord, dataDictionary) {
      const pinyinText = pinyinPro.pinyin(hanziWord, { toneType: "mark" }) || "";
      const definition = dataDictionary[hanziWord] || "No definition available";

      const span = document.createElement("span");
      span.classList.add("hanzi-group");
      span.dataset.pinyin = pinyinText;
      span.dataset.bsToggle = "popover";
      span.dataset.bsTrigger = "manual"; 
      span.dataset.bsPlacement = "top";
      span.dataset.bsContent = `<strong>${hanziWord}</strong><br>${pinyinText}<br>${definition}`;
      span.dataset.bsHtml = "true";

      if (pinyinText) {
          const pinyinSpan = document.createElement("span");
          pinyinSpan.classList.add("pinyin");
          pinyinSpan.textContent = pinyinText;
          span.appendChild(pinyinSpan);
      }

      span.appendChild(document.createTextNode(hanziWord));
      parent.appendChild(span);
  }

      function createPlainTextSpan(parent, text) {
          const span = document.createElement("span");
          span.classList.add("plain-text");
          span.textContent = text;
          parent.appendChild(span);
      }

      function updatePinyinDisplay() {
          const isPinyinEnabled = localStorage.getItem("showPinyin") === "true";
          document.querySelectorAll(".dialog-container").forEach(section => {
              section.classList.toggle("show-pinyin", isPinyinEnabled);
          });
          document.getElementById("togglePinyin").checked = isPinyinEnabled;
      }

      function updateTranslationDisplay() {
          const isTranslationEnabled = localStorage.getItem("showTranslation") === "true";
          document.querySelectorAll(".dialog-container").forEach(section => {
              section.classList.toggle("show-translation", isTranslationEnabled);
          });
          document.getElementById("toggleTranslation").checked = isTranslationEnabled;
      }

      document.getElementById("togglePinyin").addEventListener("change", function () {
          localStorage.setItem("showPinyin", this.checked);
          updatePinyinDisplay();
      });

      document.getElementById("toggleTranslation").addEventListener("change", function () {
          localStorage.setItem("showTranslation", this.checked);
          updateTranslationDisplay();
      });

      function initializePopovers() {
      document.querySelectorAll('[data-bs-toggle="popover"]').forEach(el => {
          const popover = new bootstrap.Popover(el);

          el.addEventListener("click", function (event) {
              event.stopPropagation();

              if (activePopover && activePopover !== popover) {
                  activePopover.hide();
              }

              if (activePopover === popover) {
                  activePopover.hide();
                  activePopover = null;
              } else {
                  popover.show();
                  activePopover = popover;
              }
          });
      });

      // Close popovers when clicking outside
      document.addEventListener("click", function (event) {
          if (activePopover && !event.target.closest(".hanzi-group")) {
              activePopover.hide();
              activePopover = null;
          }
      });
  }

      // generateDialogFromText(textBlob, translation);
      generateSections()
      generateMarkdowns()
  </script>
</html>